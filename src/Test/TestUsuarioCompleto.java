package Test;

import services.AuthService;
import services.UsuarioService;
import services.RolService;
import models.Usuario;
import models.Rol;
import utils.SessionManager;
import utils.PasswordUtils;

import java.util.List;

public class TestUsuarioCompleto {
    
    public static void main(String[] args) {
        System.out.println("=== PRUEBA COMPLETA DEL M√ìDULO DE USUARIOS ===\n");
        
        // Servicios
        AuthService authService = AuthService.getInstance();
        UsuarioService usuarioService = UsuarioService.getInstance();
        RolService rolService = RolService.getInstance();
        SessionManager sessionManager = SessionManager.getInstance();
        
        try {
            // 1. Probar autenticaci√≥n
            System.out.println("1. üîê Probando autenticaci√≥n...");
            boolean loginResult = authService.login("admin", "admin123");
            System.out.println("   Login admin: " + (loginResult ? "‚úÖ EXITOSO" : "‚ùå FALL√ì"));
            
            if (loginResult) {
                Usuario currentUser = authService.getCurrentUser();
                System.out.println("   Usuario logueado: " + currentUser.getNombreCompleto());
                System.out.println("   Rol: " + currentUser.getRolNombre());
                System.out.println("   Sesi√≥n: " + sessionManager.getSessionInfo());
            }
            
            // 2. Probar permisos
            System.out.println("\n2. üõ°Ô∏è Verificando permisos...");
            System.out.println("   Es Admin: " + authService.isAdmin());
            System.out.println("   Puede gestionar usuarios: " + authService.canManageUsers());
            System.out.println("   Puede ver reportes: " + authService.canViewReports());
            System.out.println("   Puede hacer ventas: " + authService.canMakeSales());
            
            // 3. Probar gesti√≥n de roles
            System.out.println("\n3. üë• Probando gesti√≥n de roles...");
            List<Rol> roles = rolService.obtenerTodosLosRoles();
            System.out.println("   Roles disponibles: " + roles.size());
            for (Rol rol : roles) {
                System.out.println("     - " + rol.toString());
            }
            
            // 4. Crear nuevo rol de prueba
            System.out.println("\n4. ‚ûï Creando rol de prueba...");
            Rol nuevoRol = new Rol("SUPERVISOR", "Supervisor de √°rea", 3);
            nuevoRol.setPermissionsList(List.of("sales.view", "clients.view", "products.view"));
            
            boolean rolCreado = rolService.crearRol(nuevoRol);
            System.out.println("   Rol creado: " + (rolCreado ? "‚úÖ S√ç" : "‚ùå NO"));
            
            // 5. Crear usuario de prueba
            System.out.println("\n5. üë§ Creando usuario de prueba...");
            Usuario usuarioPrueba = new Usuario(
                "Carlos", "Supervisor", "carlos@empresa.com", "csupervisor",
                "Password123!", "0999887766", "Av. Principal 123", 
                roles.size() > 2 ? roles.get(2).getId() : 3
            );
            
            boolean usuarioCreado = usuarioService.crearUsuario(usuarioPrueba);
            System.out.println("   Usuario creado: " + (usuarioCreado ? "‚úÖ S√ç" : "‚ùå NO"));
            
            // 6. Probar validaciones de contrase√±a
            System.out.println("\n6. üîë Probando validaciones de contrase√±a...");
            String[] passwordsTest = {
                "123",           // Muy simple
                "password",      // Sin n√∫meros ni may√∫sculas
                "Password123",   // Sin s√≠mbolos
                "Password123!",  // V√°lida
                "SuperSecure2024@" // V√°lida
            };
            
            for (String pwd : passwordsTest) {
                boolean valida = PasswordUtils.isValidPassword(pwd);
                System.out.println("   '" + pwd + "': " + (valida ? "‚úÖ V√°lida" : "‚ùå Inv√°lida"));
            }
            
            // 7. Probar hash y verificaci√≥n de contrase√±as
            System.out.println("\n7. üîê Probando hash de contrase√±as...");
            String passwordOriginal = "MiPasswordSegura123!";
            String hash = PasswordUtils.hashPassword(passwordOriginal);
            System.out.println("   Password original: " + passwordOriginal);
            System.out.println("   Hash generado: " + hash.substring(0, 20) + "...");
            
            boolean verificacionCorrecta = PasswordUtils.verifyPassword(passwordOriginal, hash);
            boolean verificacionIncorrecta = PasswordUtils.verifyPassword("PasswordIncorrecta", hash);
            
            System.out.println("   Verificaci√≥n correcta: " + (verificacionCorrecta ? "‚úÖ S√ç" : "‚ùå NO"));
            System.out.println("   Verificaci√≥n incorrecta: " + (verificacionIncorrecta ? "‚ùå NO" : "‚úÖ S√ç"));
            
            // 8. Probar gesti√≥n de sesi√≥n
            System.out.println("\n8. ‚è∞ Probando gesti√≥n de sesi√≥n...");
            System.out.println("   Sesi√≥n autenticada: " + authService.isAuthenticated());
            System.out.println("   Sesi√≥n expirada: " + sessionManager.isSessionExpired());
            System.out.println("   Tiempo restante: " + sessionManager.getTimeRemaining());
            System.out.println("   Cerca de expirar: " + sessionManager.isSessionNearExpiry());
            
            // 9. Probar cambio de contrase√±a
            if (usuarioCreado) {
                System.out.println("\n9. üîÑ Probando cambio de contrase√±a...");
                boolean passwordCambiada = usuarioService.cambiarPassword(
                    usuarioPrueba.getId(), 
                    "Password123!", 
                    "NuevaPassword456@"
                );
                System.out.println("   Contrase√±a cambiada: " + (passwordCambiada ? "‚úÖ S√ç" : "‚ùå NO"));
            }
            
            // 10. Probar login con usuario creado
            if (usuarioCreado) {
                System.out.println("\n10. üö™ Probando login con usuario creado...");
                authService.logout();
                
                boolean loginNuevo = authService.login("csupervisor", "NuevaPassword456@");
                System.out.println("    Login usuario nuevo: " + (loginNuevo ? "‚úÖ EXITOSO" : "‚ùå FALL√ì"));
                
                if (loginNuevo) {
                    Usuario userNuevo = authService.getCurrentUser();
                    System.out.println("    Usuario: " + userNuevo.getNombreCompleto());
                    System.out.println("    Rol: " + userNuevo.getRolNombre());
                    System.out.println("    Puede hacer ventas: " + authService.canMakeSales());
                }
            }
            
            // 11. Estad√≠sticas finales
            System.out.println("\n11. üìä Estad√≠sticas del sistema...");
            List<Usuario> todosUsuarios = usuarioService.obtenerTodosLosUsuarios();
            List<Usuario> usuariosActivos = usuarioService.obtenerUsuariosActivos();
            
            System.out.println("   Total usuarios: " + todosUsuarios.size());
            System.out.println("   Usuarios activos: " + usuariosActivos.size());
            System.out.println("   Total roles: " + rolService.obtenerTodosLosRoles().size());
            
            // 12. Logout final
            System.out.println("\n12. üö™ Logout final...");
            authService.logout();
            System.out.println("   Sesi√≥n cerrada: " + (!authService.isAuthenticated() ? "‚úÖ S√ç" : "‚ùå NO"));
            
            System.out.println("\nüéâ ¬°Pruebas del m√≥dulo de usuarios completadas exitosamente!");
            
        } catch (Exception e) {
            System.err.println("‚ùå Error durante las pruebas: " + e.getMessage());
            e.printStackTrace();
        }
    }
}